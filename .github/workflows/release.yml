name: 版本发布
on:
  push:
    # 以下使用main分支或者使用tags
    branches:
      - main
    tags:
      - v*
jobs:
  publish:
    runs-on: macos-latest

    steps:
      - name: 检出代码
        uses: actions/checkout@v3
        with:
          fetch-depth: 15

      - name: 计算哈希
        uses: seepine/hash-files@v1
        id: get-hash
        with:
          patterns: |-
            package.json
            package-lock.json

      - name: 保存缓存
        id: cache
        uses: actions/cache@v3
        with:
          path: node_modules
          key: vite-vue2-${{ steps.get-hash.outputs.hash }}

      - name: 安装依赖
        if: steps.cache.outputs.cache-hit != 'true'
        run: npm i --registry=http://registry.npmmirror.com

      - name: 构建发布(开发版)
        if: ${{ github.ref == 'refs/heads/main' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          MINIO_USER: ${{ secrets.MINIO_USER }}
          MINIO_PASSWORD: ${{ secrets.MINIO_PASSWORD }}
          MODE: dev
        run: echo "Building and publishing (development version)"
